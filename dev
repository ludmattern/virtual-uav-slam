#!/bin/bash
set -e

# Configuration
IMAGE_NAME="virtual-uav-slam:dev"
CONTAINER_NAME="virtual-uav-slam-dev"
WORKSPACE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

build() {
	echo "Building Docker image: $IMAGE_NAME"
	docker build -t $IMAGE_NAME .
	echo "Build complete!"
}

up() {
	echo "Starting development environment..."

	# Check if the image exists
	if [[ "$(docker images -q $IMAGE_NAME 2>/dev/null)" == "" ]]; then
		echo "Image not found. Building first..."
		build
	fi

	# Process command line arguments
	local COMMAND=""
	if [ "$1" = "-c" ] && [ -n "$2" ]; then
		COMMAND="source /opt/ros/humble/setup.bash && $2"
		shift 2
	else
		COMMAND="source /opt/ros/humble/setup.bash && exec bash"
	fi

	# Run with X11 forwarding for GUI applications (Gazebo, RViz)
	# Mount the current directory to /work in the container
	docker run -it --rm \
		--name $CONTAINER_NAME \
		-e DISPLAY=$DISPLAY \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v $WORKSPACE_DIR:/work \
		--network=host \
		--workdir=/work \
		$IMAGE_NAME \
		bash -c "$COMMAND"
}

exec_cmd() {
	# Execute a command in the running container
	if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
		docker exec -it $CONTAINER_NAME "$@"
	else
		echo "Container is not running. Use './dev up' to start it first."
		exit 1
	fi
}

# Command router
case "$1" in
build)
	build
	;;
up)
	shift
	up "$@"
	;;
exec)
	shift
	exec_cmd "$@"
	;;
*)
	echo "Usage: $0 {build|up [-c command]|exec [command]}"
	echo "  build            - Build the Docker image"
	echo "  up               - Start the development container with ROS 2 environment"
	echo "  up -c \"command\"  - Run a command in the container and exit"
	echo "  exec [command]   - Execute a command in the running container"
	exit 1
	;;
esac
